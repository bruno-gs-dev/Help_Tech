<!-- Session check removed (handled by JS) -->
<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Verificar se o usuário está logado
    const user = localStorage.getItem('user');
    if (!user) {
      window.location.href = '../../login/index.html';
    }
  </script>
</head>

<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen flex items-center justify-center">

  <!-- Sistema de Notificações Customizado -->
  <div id="notification-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

  <style>
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .notification {
      animation: slideIn 0.3s ease-out;
    }

    .notification.hiding {
      animation: slideOut 0.3s ease-in;
    }
  </style>

  <div class="bg-white shadow-2xl rounded-3xl w-[90%] max-w-6xl p-0 overflow-hidden m-6">
    <!-- Cabeçalho -->
    <div
      class="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-white flex items-center justify-between rounded-t-3xl">
      <h1 class="text-3xl font-bold">Meu Perfil</h1>
      <button class="bg-white text-blue-700 px-5 py-2 rounded-xl hover:bg-gray-100 transition font-medium">Sair</button>
      <script>
        // Adicione aqui a funcionalidade do botão Sair, se necessário
        window.onload = function () {
          document.querySelector('button').addEventListener('click', function () {
            // Redireciona para a página de logout ou encerra a sessão
            localStorage.removeItem('user');
            window.location.href = '../../index.html'; // Ajuste o caminho conforme necessário
          });
        };
      </script>
    </div>

    <!-- Corpo -->
    <div class="p-10 flex flex-col lg:flex-row gap-10">
      <!-- Coluna esquerda: Foto e informações -->
      <div class="flex flex-col items-center w-full lg:w-1/3 bg-gray-50 rounded-2xl p-6 shadow-inner">
        <div class="relative">
          <div id="profile-initial"
            class="w-44 h-44 rounded-full border-4 border-blue-500 shadow-md bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
            <span class="text-white text-6xl font-bold uppercase">?</span>
          </div>
        </div>
        <h2 class="mt-4 text-xl font-semibold text-gray-800" id="display-name">Nome do Usuário</h2>
        <p class="text-gray-500" id="display-email">email@example.com</p>

        <div class="mt-6 w-full space-y-3">
          <p class="text-gray-600"><span class="font-semibold">Telefone:</span> <span id="display-phone">-</span></p>
          <p class="text-gray-600"><span class="font-semibold">Nascimento:</span> <span id="display-birthdate">-</span>
          </p>
        </div>
      </div>

      <!-- Coluna direita: Formulário -->
      <div class="flex-1 bg-gray-50 rounded-2xl p-8 shadow-inner space-y-5">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Editar informações</h3>

        <div>
          <label class="block text-sm font-semibold text-gray-700">Nome Completo</label>
          <input id="name" type="text" value=""
            class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700">E-mail</label>
          <input id="email" type="email" value=""
            class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div class="flex flex-col sm:flex-row gap-5">
          <div class="flex-1">
            <label class="block text-sm font-semibold text-gray-700">Telefone</label>
            <input id="phone" type="text" value=""
              class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
          </div>
          <div class="flex-1">
            <label class="block text-sm font-semibold text-gray-700">Data de Nascimento</label>
            <input id="birthdate" type="text" placeholder="DD/MM/YYYY" value=""
              class="mt-1 w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
          </div>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-between mt-8 gap-4">
          <button id="save-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl transition font-semibold w-full sm:w-auto">
            Salvar Alterações
          </button>

          <button id="delete-btn"
            class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-xl transition font-semibold w-full sm:w-auto">
            Excluir Conta
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ver o ID da sessão no console
    // console.log('ID da sessão:', <?php echo json_encode($_SESSION['user_id']); ?>);

    // API Base URL - Detecta automaticamente se está em produção ou desenvolvimento
    const API_BASE_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : '/api';

    // Função para mostrar notificações customizadas
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');

      // Criar elemento de notificação
      const notification = document.createElement('div');
      notification.className = `notification flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl max-w-md ${type === 'success'
        ? 'bg-gradient-to-r from-green-500 to-emerald-600'
        : 'bg-gradient-to-r from-red-500 to-rose-600'
        } text-white`;

      // Ícone
      const icon = type === 'success'
        ? `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
           </svg>`
        : `<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
           </svg>`;

      notification.innerHTML = `
        ${icon}
        <span class="flex-1 font-medium">${message}</span>
        <button onclick="this.parentElement.remove()" class="hover:bg-white/20 rounded-lg p-1 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;

      container.appendChild(notification);

      // Remover automaticamente após 4 segundos
      setTimeout(() => {
        notification.classList.add('hiding');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // Carregar informações do usuário ao abrir a página
    document.addEventListener('DOMContentLoaded', () => {
      carregarInformacoesUsuario();
    });

    // Função para carregar informações do banco de dados
    function carregarInformacoesUsuario() {
      fetch(`${API_BASE_URL}/capturar_informacoes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'user-info' })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const usuario = data.data;

            // Atualizar informações de exibição
            document.getElementById('display-name').textContent = usuario.name;
            document.getElementById('display-email').textContent = usuario.email;
            document.getElementById('display-phone').textContent = usuario.phone;
            document.getElementById('display-birthdate').textContent = formatDate(usuario.birthdate);

            // Atualizar inicial do email
            const emailInitial = usuario.email ? usuario.email.charAt(0).toUpperCase() : '?';
            document.querySelector('#profile-initial span').textContent = emailInitial;

            // Atualizar formulário - converte Y-m-d para DD/MM/YYYY
            document.getElementById('name').value = usuario.name;
            document.getElementById('email').value = usuario.email;
            document.getElementById('phone').value = usuario.phone;
            document.getElementById('birthdate').value = formatDate(usuario.birthdate);

            console.log('Informações carregadas:', usuario);
          } else {
            console.error('Erro ao carregar informações:', data.message);
            showNotification('Erro ao carregar informações do perfil.', 'error');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          showNotification('Erro ao conectar com o servidor.', 'error');
        });
    }

    // Converter data para DD/MM/YYYY
    function formatDate(isoDate) {
      if (!isoDate) return '-';
      const date = new Date(isoDate + 'T00:00:00');
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    // Converter de DD/MM/YYYY para YYYY-MM-DD
    function parseDateToISO(dateString) {
      const [day, month, year] = dateString.split('/');
      return `${year}-${month}-${day}`;
    }

    // Salvar alterações
    document.getElementById('save-btn').addEventListener('click', () => {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const birthdate = document.getElementById('birthdate').value;

      // Validações básicas no frontend
      if (!name.trim()) {
        showNotification('Por favor, preencha o nome.', 'error');
        return;
      }
      if (!email.trim()) {
        showNotification('Por favor, preencha o e-mail.', 'error');
        return;
      }

      // Faz a requisição para a API
      fetch(`${API_BASE_URL}/alterar_informacoes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'update-user',
          name: name,
          email: email,
          phone: phone,
          birthdate: birthdate
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification(data.message, 'success');
            // Atualizar a exibição
            document.getElementById('display-name').textContent = name;
            document.getElementById('display-email').textContent = email;
            document.getElementById('display-phone').textContent = phone;
            document.getElementById('display-birthdate').textContent = birthdate;
          } else {
            showNotification(data.message, 'error');
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          showNotification('Erro ao tentar salvar as alterações. Tente novamente.', 'error');
        });
    });

    // Excluir conta com requisição ao PHP
    document.getElementById('delete-btn').addEventListener('click', function () {
      if (confirm('Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita!')) {

        // Faz a requisição para a API
        fetch(`${API_BASE_URL}/alterar_informacoes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'delete-account' })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showNotification(data.message, 'success');
              // Redireciona para a página de login após 1 segundo
              setTimeout(() => window.location.href = '../../login/index.html', 1000);
            } else {
              showNotification(data.message, 'error');
            }
          })
          .catch(error => {
            console.error('Erro:', error);
            showNotification('Erro ao tentar excluir a conta. Tente novamente.', 'error');
          });
      }
    });
  </script>
</body>

</html>